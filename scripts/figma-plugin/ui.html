<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8" />
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
    padding: 16px;
    background: #1e1e2e;
    color: #cdd6f4;
    min-height: 200px;
  }
  h2 { font-size: 15px; margin-bottom: 12px; color: #89b4fa; }
  .status-box {
    background: #313244;
    border-radius: 8px;
    padding: 12px;
    font-size: 13px;
    margin-bottom: 12px;
    min-height: 48px;
    line-height: 1.6;
  }
  .status-box.error { border-left: 3px solid #f38ba8; color: #f38ba8; }
  .status-box.success { border-left: 3px solid #a6e3a1; color: #a6e3a1; }
  .status-box.loading { border-left: 3px solid #89b4fa; }
  button {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    background: #89b4fa;
    color: #1e1e2e;
    transition: opacity 0.2s;
  }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  .progress {
    margin-top: 10px;
    height: 6px;
    background: #45475a;
    border-radius: 3px;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background: #89b4fa;
    border-radius: 3px;
    transition: width 0.3s;
    width: 0%;
  }
</style>
</head>
<body>
<h2>ğŸ¨ Masar Platform Importer</h2>

<div class="status-box loading" id="status">
  Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù„ÙŠ...
</div>

<div class="progress" id="progressWrap" style="display:none">
  <div class="progress-bar" id="progressBar"></div>
</div>

<br/>
<button id="importBtn" disabled>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù„Ù€ Figma</button>

<script>
const statusEl   = document.getElementById('status');
const importBtn  = document.getElementById('importBtn');
const progressWrap = document.getElementById('progressWrap');
const progressBar  = document.getElementById('progressBar');

let screenshots = [];

function setStatus(msg, type = '') {
  statusEl.textContent = msg;
  statusEl.className = 'status-box ' + type;
}

// â”€â”€ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkServer() {
  try {
    const res = await fetch('http://localhost:3333/status');
    const data = await res.json();
    if (data.screenshots === 0) {
      setStatus('Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±.\nØ´ØºÙ‘Ù„: node scripts/take-screenshots.js', 'error');
    } else {
      setStatus(`âœ… Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…ØªØµÙ„ â€” ${data.screenshots} Ø´Ø§Ø´Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯`, 'success');
      importBtn.disabled = false;
    }
  } catch {
    setStatus('âŒ Ø§Ù„Ø³ÙŠØ±ÙØ± ØºÙŠØ± Ù…ØªØµÙ„!\nØ´ØºÙ‘Ù„: node scripts/figma-server.js', 'error');
    setTimeout(checkServer, 3000); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ
  }
}

// â”€â”€ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ø§Ø´Ø§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
importBtn.addEventListener('click', async () => {
  importBtn.disabled = true;
  setStatus('â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±...', 'loading');
  progressWrap.style.display = 'block';

  try {
    const res = await fetch('http://localhost:3333/screenshots');
    screenshots = await res.json();

    setStatus(`ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ${screenshots.length} frame ÙÙŠ Figma...`, 'loading');

    // Ø£Ø±Ø³Ù„ Ù„Ù„Ù€ plugin.js
    parent.postMessage({
      pluginMessage: { type: 'import-screens', screenshots }
    }, '*');
  } catch (err) {
    setStatus('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±: ' + err.message, 'error');
    importBtn.disabled = false;
  }
});

// â”€â”€ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† plugin.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onmessage = (event) => {
  const msg = event.data.pluginMessage;
  if (!msg) return;

  if (msg.type === 'progress') {
    const pct = Math.round((msg.current / msg.total) * 100);
    progressBar.style.width = pct + '%';
    setStatus(`â³ ${msg.current} / ${msg.total} â€” ${msg.name}`, 'loading');
  }

  if (msg.type === 'done') {
    progressBar.style.width = '100%';
    setStatus(`âœ… ØªÙ…! ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${msg.total} frame ÙÙŠ Figma ğŸ‰`, 'success');
    importBtn.disabled = false;
    importBtn.textContent = 'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¬Ø¯Ø¯Ø§Ù‹';
  }

  if (msg.type === 'error') {
    setStatus('âŒ Ø®Ø·Ø£: ' + msg.message, 'error');
    importBtn.disabled = false;
  }
};

// â”€â”€ Ø¨Ø¯Ø¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkServer();
</script>
</body>
</html>
